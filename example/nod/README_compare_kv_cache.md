# compare_kv_cache.py — nod モード KV キャッシュ検証

## 概要

`nod` モード（うなずきタイミング予測）において、GPT の KV キャッシュの有無が推論結果に与える影響を検証するスクリプト。3 つのアプローチ（D / E / F）を同一 WAV ファイルに対して実行し、フレームごとの出力値を比較する。

## 実行方法

```bash
cd MaAI
uv run python example/nod/compare_kv_cache.py
```

## 比較する 3 つのアプローチ

| アプローチ | 説明 | KV キャッシュ | エンコーダー |
|---|---|---|---|
| **D** | `Maai` クラスの `process()` ループ | なし | CPC (インクリメンタル) |
| **E** | `Maai` クラスの `process()` ループ | あり | CPC (インクリメンタル) |
| **F** | 20 秒スライディングウィンドウ + フルシーケンス推論 | なし | CPC (フルシーケンス) |

### D と F が一致しない理由（設計上の違い）

- **D**: 毎フレーム 1920 サンプル（320 overlap + 1600 chunk）を CPC エンコーダーに渡し、出力を `e1_full` リストに蓄積して GPT に渡す（インクリメンタル）
- **F**: 毎フレーム最大 20 秒分の音声を一括でエンコーダーに渡す（フルシーケンス）

入力長と符号化方式が根本的に異なるため、D と F は最初から一致しない。これはバグではなく、CPC エンコーダー + CConv1d の設計上の制約である。

## 出力ヘッド

各アプローチで以下の 4 つのヘッド値を収集し比較する：

| ヘッド | 説明 | 値域 |
|---|---|---|
| `p_bc` | あいづち確率 | 0〜1 |
| `p_nod_short` | 短いうなずき確率 | 0〜1 |
| `p_nod_long` | 長いうなずき確率 | 0〜1 |
| `p_nod_long_p` | 長いうなずきパラメータ | 0〜1 |

## 処理フロー

### D / E: `run_maai_nod()`

1. `Maai(mode='nod')` をインスタンス化（ダミー入力使用）
2. WAV を 1600 サンプル（0.1 秒）ずつ `process()` に投入
3. `result_dict_queue` から結果を回収

### F: `run_sliding_window_nod()`

1. `Maai(mode='nod')` をインスタンス化（内部の `vap` モデルのみ使用）
2. 各フレームで `[max(0, t-20s), t]` の音声ウィンドウを切り出し
3. D と同一の先頭パディング（320 サンプルゼロ）を付加
4. `encode_audio()` + `forward(cache=None)` でフルシーケンス推論
5. 最終フレームの出力値を収集

## 可視化

`visualizations/kv_cache_comparison/nod_kv_cache_comparison.png` に以下を出力：

- 1 段目: 波形（User + ERICA）
- 2〜5 段目: 各ヘッド（p_bc, p_nod_short, p_nod_long, p_nod_long_p）の D / E / F 重畳プロット

各ヘッドのタイトルに D vs E / D vs F の最大差分を表示。

## コンソール出力

- 各アプローチの統計量（min / max / mean）
- D vs E の全ヘッド差分（max / mean）
- D vs F の全ヘッド差分（20 秒以降のみの差分も含む）
- 特定フレーム（199, 249, 299）での D vs F の診断値

## 設定パラメータ

| パラメータ | デフォルト値 | 説明 |
|---|---|---|
| `WAV_FILE` | `example/wav_sample/jpn_sumida_16k.wav` | 入力 WAV ファイル |
| `DEVICE` | `cuda` / `cpu` | 推論デバイス（自動検出） |
| `FRAME_RATE` | 10 | フレームレート (Hz) |
| `CROP_SEC` | 40.0 | クロップ長 (秒) |
| `CROP_OFFSET_SEC` | 7.5 | クロップ開始オフセット (秒) |

## 期待される結果

- **D vs E**: KV キャッシュの有無による差分はごく微小（浮動小数点精度内）
- **D vs F**: CPC エンコーダーのインクリメンタル処理とフルシーケンス処理の差異により、一定の差分が存在する
